name: ğŸ›¡ï¸ PR to Main - Strict Validation

# ä»…åœ¨ PR åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]

# è®¾ç½®å¹¶å‘æ§åˆ¶ï¼Œç¡®ä¿åŒä¸€ PR åªè¿è¡Œä¸€ä¸ªå·¥ä½œæµ
concurrency:
  group: pr-main-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ğŸ·ï¸ æ£€æŸ¥è·³è¿‡éªŒè¯æ ‡ç­¾
  check-skip-label:
    name: ğŸ·ï¸ Check Skip Validation Label
    runs-on: ubuntu-latest
    outputs:
      skip-validation: ${{ steps.check-label.outputs.skip-validation }}
    
    steps:
    - name: ğŸ·ï¸ Check for skip-validation label
      id: check-label
      run: |
        if [[ "${{ contains(github.event.pull_request.labels.*.name, 'skip-validation') }}" == "true" ]]; then
          echo "skip-validation=true" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Found 'skip-validation' label - validation checks will be skipped"
        else
          echo "skip-validation=false" >> $GITHUB_OUTPUT
          echo "ğŸ” No 'skip-validation' label found - proceeding with validation"
        fi
    
    - name: ğŸ“‹ Create skip validation notice
      if: steps.check-label.outputs.skip-validation == 'true'
      run: |
        echo "## âš ï¸ Validation Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This PR has the \`skip-validation\` label, so strict validation checks have been bypassed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**âš ï¸ Important:**" >> $GITHUB_STEP_SUMMARY
        echo "- Code quality checks have been skipped" >> $GITHUB_STEP_SUMMARY
        echo "- Manual review is strongly recommended" >> $GITHUB_STEP_SUMMARY
        echo "- This should only be used in exceptional circumstances" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Requested by:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
        echo "**Label added by:** Administrator" >> $GITHUB_STEP_SUMMARY

  # ğŸ”’ ä¸¥æ ¼çš„ä»£ç è´¨é‡æ£€æŸ¥
  strict-validation:
    name: ğŸ›¡ï¸ Strict Code Quality Validation
    runs-on: ubuntu-latest
    # è·³è¿‡è‰ç¨¿ PR å’Œå¸¦æœ‰ skip-validation æ ‡ç­¾çš„ PR
    if: github.event.pull_request.draft == false && !contains(github.event.pull_request.labels.*.name, 'skip-validation')
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºæ¯”è¾ƒ
        fetch-depth: 0
        
    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
        
    - name: ğŸ“¥ Install dependencies
      working-directory: ./frontend
      run: npm ci
      
    # TypeScript ä¸¥æ ¼æ£€æŸ¥
    - name: ğŸ”· TypeScript Strict Check
      working-directory: ./frontend
      run: |
        echo "ğŸ”· Running TypeScript strict validation..."
        npx tsc --noEmit --strict
        echo "âœ… TypeScript validation passed"
      
    # ESLint é›¶å®¹å¿æ£€æŸ¥
    - name: ğŸ§¹ ESLint Zero-Tolerance Check
      working-directory: ./frontend
      run: |
        echo "ğŸ§¹ Running ESLint with zero warnings tolerance..."
        npm run lint -- --max-warnings 0
        echo "âœ… ESLint validation passed"
    
    # ç»„ä»¶ä½¿ç”¨æ£€æŸ¥ - ä¸¥æ ¼æ¨¡å¼
    - name: ğŸ” Unused Components Check
      working-directory: ./frontend
      run: |
        echo "ğŸ” Checking for unused components..."
        npm run check:components
        if [ $? -ne 0 ]; then
          echo "âŒ Found unused components - this will block the merge"
          exit 1
        fi
        echo "âœ… All components are being used"
    
    # ä¾èµ–æ£€æŸ¥ - ä¸¥æ ¼æ¨¡å¼
    - name: ğŸ“¦ Dependencies Validation
      working-directory: ./frontend
      run: |
        echo "ğŸ“¦ Validating dependencies..."
        npm run check:deps
        if [ $? -ne 0 ]; then
          echo "âŒ Dependency validation failed - this will block the merge"
          exit 1
        fi
        echo "âœ… Dependencies validation passed"
    
    # i18n å®Œæ•´æ€§æ£€æŸ¥ - ä¸¥æ ¼æ¨¡å¼
    - name: ğŸŒ i18n Integrity Check
      working-directory: ./frontend
      run: |
        echo "ğŸŒ Running comprehensive i18n validation..."
        
        # è¿è¡Œ i18n åˆ†æå¹¶æ•è·è¾“å‡º
        npm run analyze:i18n > i18n_report.txt 2>&1
        cat i18n_report.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±çš„é”®
        if grep -q "missing in" i18n_report.txt; then
          echo "âŒ Found missing i18n keys - this will block the merge"
          echo "Please run 'npm run translate:missing:execute' to fix missing translations"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ä¸ä¸€è‡´çš„é”®
        if grep -q "inconsistent" i18n_report.txt; then
          echo "âŒ Found inconsistent i18n keys - this will block the merge"  
          echo "Please run 'npm run translate:inconsistent:execute' to fix inconsistencies"
          exit 1
        fi
        
        echo "âœ… i18n integrity check passed"
        rm i18n_report.txt
    
    # å®‰å…¨å®¡è®¡ - ä¸¥æ ¼æ¨¡å¼
    - name: ğŸ”’ Security Audit
      working-directory: ./frontend
      run: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level=moderate
        if [ $? -ne 0 ]; then
          echo "âŒ Security vulnerabilities found - this will block the merge"
          echo "Please run 'npm audit fix' to resolve security issues"
          exit 1
        fi
        echo "âœ… Security audit passed"
    
    # æ„å»ºæµ‹è¯• - ç”Ÿäº§æ¨¡å¼
    - name: ğŸ—ï¸ Production Build Test
      working-directory: ./frontend
      run: |
        echo "ğŸ—ï¸ Testing production build..."
        npm run build
        if [ $? -ne 0 ]; then
          echo "âŒ Production build failed - this will block the merge"
          exit 1
        fi
        echo "âœ… Production build successful"
        
        # éªŒè¯è¾“å‡ºç›®å½•
        if [ ! -d "out" ]; then
          echo "âŒ Build output directory not found"
          exit 1
        fi
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        if [ ! -f "out/index.html" ]; then
          echo "âŒ Main index.html not found in build output"
          exit 1
        fi
        
        echo "âœ… Build output validation passed"
    
    # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
    - name: ğŸ“Š Generate Validation Report
      if: always()
      working-directory: ./frontend
      run: |
        echo "## ğŸ›¡ï¸ PR to Main - Validation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Pull Request:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Source Branch:** \`${{ github.head_ref }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Target Branch:** \`${{ github.base_ref }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âœ… Validation Checks Completed:" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”· TypeScript strict validation" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ§¹ ESLint zero-tolerance check" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” Unused components detection" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ Dependencies validation" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ i18n integrity check" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”’ Security audit" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ—ï¸ Production build test" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "### ğŸ‰ All Validations Passed!" >> $GITHUB_STEP_SUMMARY
          echo "This PR is ready for review and can be safely merged to main." >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
          echo "This PR has failed one or more validation checks." >> $GITHUB_STEP_SUMMARY
          echo "Please fix the issues above before merging." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Repository administrators can override these checks if necessary." >> $GITHUB_STEP_SUMMARY
        fi

  # ğŸ” å˜æ›´å½±å“åˆ†æ
  change-analysis:
    name: ğŸ” Change Impact Analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
        
    - name: ğŸ“¥ Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: ğŸ” Analyze changed files
      run: |
        echo "## ğŸ” Change Impact Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # è·å–å˜æ›´çš„æ–‡ä»¶
        changed_files=$(git diff --name-only origin/main...HEAD)
        
        if [ -z "$changed_files" ]; then
          echo "No files changed in this PR." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ğŸ“ Changed Files:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$changed_files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åˆ†ææ–‡ä»¶ç±»å‹
          echo "### ğŸ“Š File Type Analysis:" >> $GITHUB_STEP_SUMMARY
          echo "- **TypeScript/JavaScript:** $(echo "$changed_files" | grep -E '\.(ts|tsx|js|jsx)$' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- **Styles:** $(echo "$changed_files" | grep -E '\.(css|scss|sass)$' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration:** $(echo "$changed_files" | grep -E '\.(json|yml|yaml|toml)$' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation:** $(echo "$changed_files" | grep -E '\.(md|txt)$' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- **Other:** $(echo "$changed_files" | grep -vE '\.(ts|tsx|js|jsx|css|scss|sass|json|yml|yaml|toml|md|txt)$' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥æ˜¯å¦æ¶‰åŠå…³é”®æ–‡ä»¶
          critical_files=$(echo "$changed_files" | grep -E "(package\.json|tsconfig\.json|next\.config\.|tailwind\.config\.|\.github/)")
          if [ ! -z "$critical_files" ]; then
            echo "### âš ï¸ Critical Files Modified:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$critical_files" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "**Please ensure these changes are thoroughly reviewed.**" >> $GITHUB_STEP_SUMMARY
          fi
        fi
    
    - name: ğŸ“ˆ Calculate change statistics
      run: |
        echo "### ğŸ“ˆ Change Statistics:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        git diff --stat origin/main...HEAD >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  # ğŸ“‹ æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
  final-status:
    name: ğŸ“‹ Final Status Check
    runs-on: ubuntu-latest
    needs: [check-skip-label, strict-validation, change-analysis]
    if: always()
    
    steps:
    - name: ğŸ“‹ Final validation summary
      run: |
        echo "## ğŸ“‹ PR Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥æ˜¯å¦è·³è¿‡éªŒè¯
        if [ "${{ needs.check-skip-label.outputs.skip-validation }}" = "true" ]; then
          echo "**Status:** âš ï¸ Validation Skipped" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** skip-validation label present" >> $GITHUB_STEP_SUMMARY
          echo "**Change Analysis:** ${{ needs.change-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ·ï¸ **Validation checks have been bypassed due to administrator override.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âš ï¸ Please ensure manual review has been completed before merging.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Validation Status:** ${{ needs.strict-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Change Analysis:** ${{ needs.change-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.strict-validation.result }}" = "success" ]; then
            echo "âœ… **This PR meets all quality standards and is ready for merge.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **This PR has validation failures that must be addressed.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ”§ How to Fix:" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the failed checks above" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix the identified issues in your code" >> $GITHUB_STEP_SUMMARY
            echo "3. Push the fixes to update this PR" >> $GITHUB_STEP_SUMMARY
            echo "4. Wait for the checks to run again" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸš« Override Options:" >> $GITHUB_STEP_SUMMARY
            echo "Repository administrators can bypass these checks by:" >> $GITHUB_STEP_SUMMARY
            echo "- Using the \"Merge without waiting for requirements\" option" >> $GITHUB_STEP_SUMMARY
            echo "- Adding the \`skip-validation\` label to this PR" >> $GITHUB_STEP_SUMMARY
          fi
        fi
    
    # å¦‚æœéªŒè¯å¤±è´¥ä¸”æ²¡æœ‰è·³è¿‡æ ‡ç­¾ï¼Œè®¾ç½®å¤±è´¥çŠ¶æ€
    - name: âŒ Fail if validation failed
      if: needs.strict-validation.result != 'success' && needs.check-skip-label.outputs.skip-validation != 'true'
      run: |
        echo "Validation failed - blocking merge"
        exit 1
